#!/usr/bin/with-contenv sh

CLOUDPLOW_CONFIG="/opt/cloudplow/config.json"

echo "Waiting mergerfs mount..."
while [ 0 -eq `ps -ef | grep abc | grep mergerfs | wc -l` ]; do
  sleep 1
done
echo "Waiting mergerfs mount done."

if [ ! -f $CLOUDPLOW_CONFIG ]; then
  echo "First run initializing cloudplow..."
  s6-setuidgid abc cloudplow run
  jq .core.rclone_binary_path="\"/usr/bin/rclone\"" $CLOUDPLOW_CONFIG > tmp.$$.json && mv tmp.$$.json $CLOUDPLOW_CONFIG
  jq .core.rclone_config_path="\"/rclone/.rclone.conf\"" $CLOUDPLOW_CONFIG > tmp.$$.json && mv tmp.$$.json $CLOUDPLOW_CONFIG
  chown abc:abc $CLOUDPLOW_CONFIG
fi

echo "Executing cloudplow for remote upload"
exec s6-setuidgid abc cloudplow run
